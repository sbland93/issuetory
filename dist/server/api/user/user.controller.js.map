{"version":3,"sources":["../../../../server/api/user/user.controller.js"],"names":[],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\r\n\r\nvar UserService = require('./user.service');\r\nvar Mailing = require('../../components/mails/mail.service');\r\n\r\nvar validationError = function(res, err) {\r\n  return res.json(422, err);\r\n};\r\n\r\nexports.index = index;\r\nexports.create = create;\r\nexports.show = show;\r\nexports.destroy = destroy;\r\nexports.changePassword = changePassword;\r\nexports.me = me;\r\nexports.authCallback = authCallback;\r\nexports.getUsernumber = getUsernumber;\r\nexports.sendEmail = sendEmail;\r\nexports.emailValidate = emailValidate;\r\nexports.confirmNumber = confirmNumber;\r\nexports.updateScore = updateScore;\r\n\r\n/**\r\n * Get list of users\r\n * restriction: 'admin'\r\n */\r\nfunction index(req, res) {\r\n  UserService\r\n    .index()\r\n    .then(function(users) {\r\n      res.json(200, users);\r\n    })\r\n    .catch(function(err) {\r\n      res.send(500, err);\r\n    });\r\n};\r\n\r\n/**\r\n * Creates a new user\r\n */\r\nfunction create(req, res, next) {\r\n  UserService\r\n    .create(req.body)\r\n    .then(function(token) {\r\n      res.json({ token: token });\r\n    })\r\n    .catch(function(err) {\r\n      return validationError(res, err);\r\n    });\r\n};\r\n\r\n/**\r\n * Get a single user\r\n */\r\nfunction show(req, res, next) {\r\n  UserService\r\n    .show(req.params.id)\r\n    .then(function(profile) {\r\n      console.log('For Test: Profile', profile);\r\n      res.json(profile);\r\n    })\r\n    .catch(function(err) {\r\n      if(err && err.code && err.code === 'USER_NOT_FOUND') {\r\n        return res.send(401);\r\n      } \r\n      if (err) return next(err);\r\n    });\r\n};\r\n\r\n/**\r\n * Deletes a user\r\n * restriction: 'admin'\r\n */\r\nfunction destroy(req, res) {\r\n  UserService\r\n    .destroy(req.params.id)\r\n    .then(function() {\r\n      res.send(204);\r\n    })\r\n    .catch(function(err) {\r\n      if (err) return res.send(500, err);\r\n    });\r\n};\r\n\r\n/**\r\n * Change a users password\r\n */\r\nfunction changePassword(req, res, next) {\r\n  var userId = req.user._id;\r\n  var oldPass = String(req.body.oldPassword);\r\n  var newPass = String(req.body.newPassword);\r\n\r\n  UserService\r\n    .changePassword(userId, oldPass, newPass)\r\n    .then(function() {\r\n      res.send(200);\r\n    })\r\n    .catch(function(err) {\r\n      if(err && err.code && err.code === 'FORBIDDEN') {\r\n        return res.send(403);\r\n      } \r\n      return validationError(res, err);\r\n    });\r\n};\r\n\r\n/**\r\n * Get my info\r\n */\r\nfunction me(req, res, next) {\r\n  UserService\r\n    .me(req.user._id)\r\n    .then(function(user) {\r\n      res.json(user);\r\n    })\r\n    .catch(function(err) {\r\n      if(err && err.code && err.code === 'USER_NOT_FOUND') {\r\n        return res.send(401);\r\n      } \r\n      if (err) return next(err);\r\n    });\r\n};\r\n\r\n\r\n\r\n\r\n/**\r\n * Authentication callback\r\n */\r\nfunction authCallback(req, res, next) {\r\n  res.redirect('/');\r\n};\r\n\r\n\r\n\r\n//for controll The User Score\r\nfunction updateScore(req, res, next) {\r\n  console.log('updateScore and req.body.score', req.body.score);\r\n  UserService.updateScore(req.params.id, req.body.score)\r\n  .then(function(affectedNumber){\r\n    res.json(affectedNumber);\r\n  })\r\n  .catch(function(err){\r\n    if(err) return next(err);\r\n  })\r\n}\r\n\r\n\r\n\r\n\r\n//make email validate! From false to true\r\nfunction emailValidate(req, res, next) {\r\n\r\n  UserService.emailValidates(req.user._id).then(function(user){\r\n    res.sendStatus(200);\r\n  })\r\n  .catch(function(err){\r\n    if(err) return next(err);\r\n    console.log('For Test: emailvalidate error [user.controller.js 137]', error);\r\n  })\r\n\r\n}\r\n\r\n\r\n//getUsernumber (it is because of safety, because we delete ret.usernumber on to JSON)\r\nfunction getUsernumber(req, res, next) {\r\n  console.log('For Test: getUsernumber() is called......');\r\n  console.log('For Test: req.user is [called from user.controller.js 145]', req.user)\r\n  var id = req.user._id;\r\n\r\n\r\n  UserService.getUsernumber(id).then(function(number){\r\n    req.number = number;\r\n    console.log(req.number);\r\n    next();\r\n  })\r\n  .catch(function(err){\r\n    if(err) return next(err);\r\n  })\r\n\r\n}\r\n\r\n\r\n//sendEmail with usernumber(equipped into req by getUsernumber())\r\n\r\nfunction sendEmail(req, res, next) {\r\n  console.log('For Test: sendEmail..[called from user.controller.js 164]');\r\n  var options = {};\r\n  var html = '<div>validation number:'+req.number+'</div>';\r\n  var from = '\"constructive\" <rltmqj@yonsei.ac.kr>';\r\n  var subject = 'constructive validatation!';\r\n\r\n  options.html = html;\r\n  options.from = from;\r\n  options.to = req.user.email;\r\n  options.subject = subject;\r\n\r\n  Mailing.sendMail(options).then(function(){\r\n    res.sendStauts(204);\r\n  });\r\n}\r\n\r\n\r\nfunction confirmNumber(req, res, next) {\r\n  console.log('For Test: req.body.number is', req.body.number);\r\n  console.log('For Test: req.number is', req.number);\r\n  if(req.number == req.body.number){\r\n\r\n    next();\r\n  }\r\n  else{\r\n    res.sendStatus(400);\r\n  }\r\n\r\n}"]}