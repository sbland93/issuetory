{"version":3,"sources":["../../../../server/api/user/user.service.js"],"names":[],"mappings":"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","file":"user.service.js","sourcesContent":["\r\n'use strict';\r\n\r\nvar Q = require('q'),\r\n    User = require('./user.model'),\r\n    passport = require('passport'),\r\n    config = require('../../config/environment'),\r\n    jwt = require('jsonwebtoken');\r\n\r\n\r\n/**\r\n * exports 내역 \r\n * @type {[type]}\r\n */\r\nexports.index = index;\r\nexports.create = create;\r\nexports.show = show;\r\nexports.destroy = destroy;\r\nexports.changePassword = changePassword;\r\nexports.me = me;\r\nexports.emailValidates = emailValidates;\r\nexports.getUsernumber = getUsernumber;\r\nexports.updateScore = updateScore;\r\n\r\n\r\n\r\n/**\r\n * Get list of users\r\n * restriction: 'admin'\r\n */\r\nfunction index() {\r\n  var deferred = Q.defer();\r\n\r\n  User.find({}, '-salt -hashedPassword', function (err, users) {\r\n    if(err) return deferred.reject(err);\r\n     deferred.resolve(users);\r\n  });\r\n  return deferred.promise;\r\n};\r\n\r\n/**\r\n * Creates a new user\r\n */\r\nfunction create(params) {\r\n  var deferred = Q.defer();\r\n\r\n  var newUser = new User(params);\r\n  newUser.provider = 'local';\r\n  newUser.role = 'user';\r\n  newUser.save(function(err, user) {\r\n    if (err) return deferred.reject(err);\r\n    var token = jwt.sign({_id: user._id }, config.secrets.session, { expiresIn: 60*5 });\r\n    \r\n    deferred.resolve(token);\r\n  });\r\n  return deferred.promise;\r\n};\r\n\r\n\r\nfunction show(userId) {\r\n  var deferred = Q.defer();\r\n  User.findById(userId).populate('cards').populate('comments').exec().then(\r\n    function(user){\r\n      if (!user) return deferred.reject(\r\n        Error.new({\r\n          code: 'USER_NOT_FOUND',\r\n          message: 'User: ' + userId + ' is not found.'\r\n        })\r\n      );\r\n      deferred.resolve(user.profile);\r\n    }, function(err){\r\n       if (err) return deferred.reject(err);\r\n    })\r\n\r\n  return deferred.promise;\r\n};\r\n\r\n/**\r\n * Deletes a user\r\n * restriction: 'admin'\r\n */\r\nfunction destroy(userId) {\r\n  var deferred = Q.defer();\r\n\r\n  User.findByIdAndRemove(userId, function(err, user) {\r\n    if(err) return deferred.reject(err);\r\n    return deferred.resolve(204);\r\n  });\r\n  return deferred.promise;\r\n};\r\n\r\n/**\r\n * Change a users password\r\n */\r\nfunction changePassword(userId, oldPass, newPass) {\r\n  var deferred = Q.defer();\r\n\r\n  User.findById(userId, function (err, user) {\r\n    if(user.authenticate(oldPass)) {\r\n      user.password = newPass;\r\n      user.save(function(err) {\r\n        if (err) return deferred.reject(err);\r\n        deferred.resolve(200);\r\n      });\r\n    } else {\r\n      deferred.reject(\r\n        Error.new({\r\n          code: 'FORBIDDEN',\r\n          message: 'User: ' + userId + ' is forbidden.'\r\n        })\r\n      );\r\n    }\r\n  });\r\n  return deferred.promise;\r\n};\r\n\r\n/**\r\n * Get my info\r\n */\r\nfunction me(userId) {\r\n  var deferred = Q.defer();\r\n  console.log('For Test: UserId:', userId);\r\n  User.findOne({\r\n    _id: userId\r\n  }, '-salt -hashedPassword', function(err, user) { // don't ever give out the password or salt\r\n    if (err) return deferred.reject(err);\r\n    if (!user) return deferred.reject(\r\n      Error.new({\r\n        code: 'USER_NOT_FOUND',\r\n        message: 'User: ' + userId + ' is not found.'\r\n      })\r\n    );\r\n    deferred.resolve(user);\r\n  });\r\n  return deferred.promise;\r\n};\r\n\r\n\r\n\r\n//usernumber: user email validation number\r\n//find by number & change the validation schema from FALSE to TRUE\r\n//delete usernumber cuz it will no need.\r\n function emailValidates(userId){\r\n  var deferred = Q.defer();\r\n\r\n  User\r\n    .findOne({_id: userId}).exec(function(err, user) {\r\n      if(err) return deferred.reject(err);\r\n      if(!user) return deferred.reject(err);\r\n\r\n      user.validation = true;\r\n      console.log('For Test: user from emailValidates [user.service.js 152]', user);\r\n      //delete user.usernumber\r\n      user.usernumber = undefined;\r\n      user.save(function(err){\r\n        if(err) return deferred.reject(err);\r\n        deferred.resolve();\r\n      });/*.then(function(err, _user){\r\n        if(err) return deferred.reject(err);\r\n        deferred.resolve(_user);\r\n      })*/;\r\n    })\r\n\r\n  return deferred.promise;\r\n  \r\n}\r\n\r\n//get user number\r\nfunction getUsernumber(userId) {\r\n  var deferred = Q.defer();\r\n\r\n  User.findById(userId, function (err, user) {\r\n    if (err) return deferred.reject(err);\r\n    if (!user) return deferred.reject(\r\n      Error.new({\r\n        code: 'USER_NOT_FOUND',\r\n        message: 'User: ' + userId + ' is not found.'\r\n      })\r\n    );\r\n\r\n    deferred.resolve(user.usernumber);\r\n  });\r\n  return deferred.promise;\r\n};\r\n\r\n\r\nfunction updateScore(userId, amount) {\r\n  console.log('updateScore user.service.js');\r\n  var deferred = Q.defer();\r\n\r\n  var conditions = { _id: userId }\r\n  , update = { $inc: { score: amount }};\r\n\r\n  User.update(conditions, update, callback);\r\n\r\n  function callback (err, numAffected) {\r\n    // numAffected is the number of updated documents\r\n    if(err) deferred.reject(err);\r\n    deferred.resolve(numAffected);\r\n  }\r\n\r\n  return deferred.promise;\r\n}"]}